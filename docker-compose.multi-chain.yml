version: '3.8'

# Multi-chain forward and backfill workers
# Connects to existing infrastructure (PostgreSQL, Redis Sentinel, ERPC)
#
# All configuration comes from .env.docker file
# No need to override environment variables here
#
# Usage:
#   docker-compose -f docker-compose.multi-chain.yml up -d
#   docker-compose -f docker-compose.multi-chain.yml logs -f
#   docker-compose -f docker-compose.multi-chain.yml down

x-worker-base: &worker-base
  build: .
  restart: unless-stopped
  env_file:
    - .env.docker
  networks:
    - indexer-network
  healthcheck:
    test: ["CMD", "sh", "-c", "pgrep forward || pgrep backfill"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 10s

services:
  # =============================================================================
  # ETHEREUM (Chain ID: 1)
  # =============================================================================
  forward-ethereum:
    <<: *worker-base
    container_name: indexer-forward-ethereum
    command: ["./forward", "--chain=1"]

  backfill-ethereum:
    <<: *worker-base
    container_name: indexer-backfill-ethereum
    command: ["./backfill", "--chain=1"]

  # =============================================================================
  # POLYGON (Chain ID: 137)
  # =============================================================================
  forward-polygon:
    <<: *worker-base
    container_name: indexer-forward-polygon
    command: ["./forward", "--chain=137"]

  backfill-polygon:
    <<: *worker-base
    container_name: indexer-backfill-polygon
    command: ["./backfill", "--chain=137"]

  # =============================================================================
  # ARBITRUM (Chain ID: 42161)
  # =============================================================================
  forward-arbitrum:
    <<: *worker-base
    container_name: indexer-forward-arbitrum
    command: ["./forward", "--chain=42161"]

  backfill-arbitrum:
    <<: *worker-base
    container_name: indexer-backfill-arbitrum
    command: ["./backfill", "--chain=42161"]

  # =============================================================================
  # BSC (Chain ID: 56)
  # =============================================================================
  forward-bsc:
    <<: *worker-base
    container_name: indexer-forward-bsc
    command: ["./forward", "--chain=56"]

  backfill-bsc:
    <<: *worker-base
    container_name: indexer-backfill-bsc
    command: ["./backfill", "--chain=56"]

networks:
  indexer-network:
    driver: bridge
